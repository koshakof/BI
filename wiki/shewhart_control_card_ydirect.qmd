---
lang: ru

title: 'Применяем ГОСТ стандарт РФ «Контрольные карты Шухарта» для оптимизация рекламных кампаний и других источников трафика'

description-meta: 'Оптимизация рекламных кампаний, SEO трафика и любых других источников с помощью метода шести сигм (контрольных карт Шухарта)'

date: today
date-format:  D dddd MMM YYYY

format:
  html:
    toc: true
    toc-location: left
    cap-location: top
editor_options: 
  chunk_output_type: console
execute:
  warning: false
  message: false
  error: false
  echo: false
---


## Кто такие «контрольные карты Шухарта»

Контрольные карты Шухарта (метод шести сигм) — статистический метод, который позволяет оптимизировать / усовершенствовать процессы в компании. В основе метода лежит предположение, что любые динамически меняющиеся во времени показатели могут быть разделены на 2 группы: системные и частные.

Предполагается, что если значение показателя трактуется как неудовлетворительное, то необходимо определиться с корректными методами его исправления, принимая во внимание тот факт, что системные проблемы должны корректироваться системными методами, а частные — частными. 

Кроме того, метод используется для оценки повышения / снижения качества управления, предлагая конкретные индикативные показатели, отражающие нарастающую или снижающуюся вариативность процесса (вариативность в концепции рассматривается как главный «враг» эффективности).

Главная задача научиться различать состояния, в которых находится система, а затем решать, что и кому надо с ней делать (или не делать). ККШ — это и есть диагностический инструмент для ответа на вопрос: надо или не надо вмешиваться в систему, и если надо, то кому?

Контрольные карты Шухарта приняты и введены в действие [Постановлением Госстандарта России от 15 апреля 1999 г. N 127](https://docs.cntd.ru/document/1200025672)




## Какие задачи решают ККШ

1. Главная задача — оптимизация источников трафика по интересующим нас данным. После внесенных изменений в рекламную кампанию (РК) вы практически сразу увидите результат.
2. Контроль подрядчиков. С помощью контрольных карт вы увидите результаты работ и поймёте, были ли вообще выполнены какие-либо работы.
3. Аудит рекламных систем.




## Сфера применения

Контрольные карты широко применяются в сферах производства и в меньшей степени в сфере услуг. В нашем случае мы применяем карты для улучшения показателей в рекламных кампаниях. Вообще, ККШ можно применить для улучшения любых показателей в бизнесе, которые накладываются на временной ряд.

В данном кейсе я покажу, как с помощью кода на R можно построить различные типы ККШ на примере действующей рекламной кампании. Тип рекламной кампании, собственно, как и источник не имеют значения, так как анализировать можно практически любые параметры из любых источников, растянутых на временном интервале.




## Как работать с картами

Возможно четыре состояния, в которых находится любой производственный процесс. 

- Идеальное состояние – процесс управляем и 100% продукции соответствует допускам. 
- Пороговое состояние – процесс управляем, но не 100% продукции соответствует допускам. 
- На грани хаоса – процесс неуправляем, хотя вся выпускаемая продукция соответствует допускам.
- Состояние хаоса – процесс неуправляем, и периодически производится брак. 

Энтропия постоянно воздействует на все процессы, вызывая ухудшение качества, разрушение, износ и разрывы, аварии и отказы. Т.е. если не управлять системами привлечения трафика (seo, контекст, smm) они в любом случаи затухнут, просто потому что так работают законы вселенной.

**Критерии роста системы**

Шухарт и Деминг выделили два критерия которые должны указывать на то, что кампания активно растет:

- среднеарифметическая растет или снижается в зависимости от параметра;
- границы сигмы становятся все более узкими. Сокращая вариативность параметра мы берем управление под контроль.


**Критерии ухудшения системы**

- средняя арифметическая снижается или растет, если речь идет о негативном параметре;
- на протяжении шести и более дней (контрольных интервалов)значения скачут с нарастающей волатильностью;
- если несколько дней подряд наблюдается выход за пределы контрольных границ;
- если шесть и более дней наблюдается негативная тенденция в значениях (неважно, сверху или снизу). Т.е. значения находятся над или под средней линией.

Правила для обнаружения «вышедших из-под контроля» или неслучайных условий:

- [Western Electric rules](https://en.wikipedia.org/wiki/Western_Electric_rules)
- [Nelson rules](https://en.wikipedia.org/wiki/Nelson_rules)




## Примеры

Рассмотрим несколько примеров как выглядят различные типы карт в различных срезах.

Но сначала давайте попробуем сделать какие-то выводы по графикам, которые вы видите в Метрике или в Директе.

Для примера возьмем анализ расходов в разрезе кампаний. Построим столбчатый график с накоплением и график с точками и линиями.

Да, на графике видно, что что-то происходит. Какие-то РК включаются, какие-то выключаются, но стоит ли переживать из-за этого. Что за пик случился 05.02. и что произошло дальше. 

```{r}
# загрузка библиотек 
library(qcc)
library(dplyr)
library(ggplot2)
library(DT)
library(tsibble)
library(imputeTS)
```


```{r}
# путь
file_path <- '~/GitHub/BI/wiki/data/'
```


```{r}
# быстрая загрузка tydiverse подходом
df <- vroom::vroom(
  file = paste0(file_path, 'data_ccsh.csv'), 
  show_col_types = FALSE
  ) |> 
  mutate(
    CampaignId = as.character(CampaignId),
    AdId = as.character(AdId)
    ) |> 
  select(Date:Bounces, Goals)
```




### XmR-карты

Карты индивидуальных значений и размахов ($XmR-карты$) применяются, когда нет возможности сгруппировать данные.  Данный тип карт менее точен, чем карты средних значений, однако они полезны при старте рекламных кампаний.

Как видно из названия карт применяются два их вида:

- карта индивидуальных значений ($X-карта$). Строится карта в декартовой системе координат, где по оси абсцисс расположены даты, а на оси ординат значения исследуемой метрики.
- карта размахов. Размах — это разность между наибольшим и наименьшим значениями и обозначается символом $mR$. Размах практически не отражает «срединных» значений, поэтому он неэффективен для описания больших массивов данных и используется для описания множеств, число элементов которых не превосходит 15.


Рассмотрим mR-карту по всему аккаунту за последние 15 дней.

```{r}
# подготовка таблицы для анализа аккаунта в разрезе даты по дням
acc_date <- df |> 
  reframe(
    across(where(is.numeric), sum),
    .by = Date
    ) |>
  mutate(
    Cost = round(Cost),
    CPA = if_else(Goals == 0 , 0, round(Cost / Goals)),
    CPC = if_else(Cost == 0, 0, round(Cost / Clicks)),
    CTR = if_else(Clicks == 0, 0, round(Clicks / Impressions * 100, 1)),
    CR = if_else(Goals == 0, 0, round(Goals / Clicks * 100, 1)),
    SR = if_else(Clicks == 0, 0, round(Sessions / Clicks, 1)),
    BR = if_else(Bounces == 0, 0, round(Bounces / Sessions * 100, 1))
    )
```


```{r}
# набор данных для R-карты в виде матрицы
mr_cost <- acc_date |>
  filter(Date >= '2024-03-03') |> 
  mutate(Lead = lead(Cost)) |> 
  select(Cost, Lead) |> 
  filter(!is.na(Lead)) |> 
  as.matrix()
```

```{r}
# создаем значения для оси абсцисс для R-графика
temp <- acc_date |>
  filter(Date >= '2024-03-03') |> 
  mutate(lab = clock::date_format(Date, format = "%d.%m")) |> 
  select(lab)

df_lab <- temp[1:(nrow(temp) - 1), ] |> 
  as.matrix()
```

```{r}
# данные для графика R-карты
mr_cost_plot <- qcc(
  type = "R",
  data = mr_cost,
  labels = df_lab,
  plot = FALSE
  )
```

```{r}
#| fig-width: 10
#| fig-height: 7

# график: R-карта 
plot.qcc(
  mr_cost_plot,
  axes.las = 2,
  title = "mR-карта расходов по аккаунту",
  ylab = "Расходы"
  )
```

Сразу видим что 17.03. наблюдается перерасход средств по аккаунту. Были внесены какие-то действия, которые привели к выходу за границы системых значений. Действительно, в этот день были выставлены новые значения по недельному расходу.

Рассмотрим $X-карту$ индивидуальных значений за весь анализируемый период.

```{r}
# данные для х-карты
x_cost <- qcc(
  type = "xbar.one",
  data = acc_date$Cost[1:27],
  newdata = acc_date$Cost[28:nrow(acc_date)], 
  labels = acc_date$Date[1:27] |> format("%d.%m"),
  newlabels = acc_date$Date[28:nrow(acc_date)] |> format("%d.%m"),
  plot = FALSE
  )
```


```{r}
# проверяем нижнюю границу
x_cost$limits[1] <- if_else(x_cost$limits[1] < 0, 0, x_cost$limits[1])
```


```{r}
#| fig-width: 10
#| fig-height: 7

# строим график
plot(
  x_cost, 
  axes.las = 2, 
  title = "Х-карта \n Период 1: с 09.01. Период 2: с 12.02",
  ylab = "Расход",
  restore.par = T
  )
```

На графике за весь период видим заметны выходы за границы системы в 

Пересобирем график для большей информативности.

```{r}
# устанавливаем предупреждающие границы
sg1 <- limits.xbar.one(x_cost$center, x_cost$std.dev, x_cost$sizes, 1)
sg2 <- limits.xbar.one(x_cost$center, x_cost$std.dev, x_cost$sizes, 2)
sg3 <- limits.xbar.one(x_cost$center, x_cost$std.dev, x_cost$sizes, 3)
```


```{r}
# Определяем, какие точки будут красными и желтыми
red_points <- x_cost$violations$beyond.limits
yellow_points <- x_cost$violations$violating.runs

# Создаем векторы цветов
colors <- rep("black", length(x))
colors[red_points] <- "red"
colors[yellow_points] <- "yellow"
```


```{r}
# Строим график
ggplot(data.frame(x, y), aes(x, y)) +
  geom_point(aes(color = factor(colors))) +
  scale_color_manual(values = c("black" = "black", "red" = "red", "yellow" = "yellow")) +
  theme_minimal()
```


Разумеется мы можем выбрать интересующую нас группу и проверить интересующую нас метрику. Например, на графике ниже видны данные по расходам в разрезе трех объявлений выбранной мною группы.

Допустим меня интересует объявление, которое отображено зеленой линией на графике. Проверим границы по бюджетам, кликам.

